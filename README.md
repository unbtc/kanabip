# 概要

Web ページ上で「カスタム文字列（カンマ区切り）」から全組み合わせ（二文字組み合わせ）を作成し、それぞれに対して BIP39 単語リストからランダムに単語を割り当てる仕組みを実装しています。また、ユーザーによる入力の補助（入力候補の提示や入力変更時の入れ替え処理）、並び替え、印刷用のバージョン生成などの機能も含まれています。

## 主な機能と処理の流れ

### 初期化処理（window.onload）
ページ読み込み時に以下の処理を実行します：
- ページ上の要素 `id="date"` に現在日時を表示。
- `updateCount()` を呼び出してカスタム文字の個数を更新。
- `generate()` を呼び出して、カスタム文字の全組み合わせに対し BIP39 単語のマッピングを生成。
- `putSuggest()` を呼び出して、BIP39 単語の候補リストを `<datalist>` 要素に設定。

### BIP39 単語リストの定義
変数 `bip39_words` は、カンマ区切りのBIP39ワードリスト（例："abandon,...,zone,zoo"）を分割して配列に変換しています。

### 入力候補リストの生成（putSuggest 関数）
`<datalist id="bip39_suggest">` の中身を一度空にし、BIP39 単語配列の各単語を `<option value="単語">` として追加します。これにより、入力フィールドで「候補表示（オートコンプリート）」が利用できるようになります。

### 文字の組み合わせ生成（getCombinations 関数）
引数で与えた文字配列 `chars` に対して、2重ループを用いて全ての 2 文字の組み合わせ（例："a" と "b" → "ab"）を生成し、結果の配列を返します。

### 配列のシャッフル（shuffleArray 関数）
引数が配列であるか確認後、Fisher–Yates シャッフルアルゴリズムの改良版として、暗号学的乱数生成関数 `crypto.getRandomValues` を使用してシャッフルします。入力配列のコピーを作成し、元の配列を改変せずにシャッフル済みの新配列を返します。

### 重複チェック（hasDuplicates 関数）
配列内の要素数と `Set` によるユニークな要素の数を比較し、重複があるかどうかを判定します。

### マッピングの生成（generate 関数）
1. **入力値取得と重複チェック**：
    - ユーザー入力欄（`id="chars"`）からカンマ区切りの文字群を取得し、重複がある場合はアラートを表示して処理を中断します。
    
2. **カスタムワードの生成**：
    - 取得した文字群に対して `getCombinations` を呼び出し、全ての 2 文字組み合わせ（カスタムワード）を作成します。

3. **BIP39 単語リストの拡張**：
    - 初めに BIP39 単語リスト全体を `shuffleArray` でシャッフルし、カスタムワード数に満たない場合は再度シャッフルした単語を足し合わせ、必要な個数を確保します。
    - 最後に全体を再度シャッフルすることで、単語の割り当てが偏らないようにしています。

4. **マッピングの割り当て**：
    - カスタムワード配列の各要素に対して、拡張した BIP39 単語リストの対応するインデックスの単語をマッピング（連想配列 `mappings`）として設定します。

5. **結果表示**：
    - マッピング数を `id="size-display"` に表示し、`updateDisplay()` を呼び出して画面上に一覧表示します。

### マッピング結果の表示（updateDisplay 関数）
`<ul id="mappings">` の中身を一度クリアし、各マッピング（カスタムワードと対応する BIP39 単語）を `<li>` 要素として追加します。各リスト項目には、カスタムワードのテキストと、編集可能な `<input>`（オートコンプリート有、候補リストは先ほど設定した `bip39_suggest`）が含まれ、入力値が変更された際には `handleInputChange` が呼ばれるよう設定しています。

### 入力変更時の処理（handleInputChange 関数）
ユーザーが入力フィールドの値を変更した場合、新しい単語が BIP39 単語リストに含まれているか確認します。含まれていなければアラートを出し、元の単語に戻します。もし新しい単語がすでに他のカスタムワードに割り当てられている場合は、そのマッピングと入れ替える（スワップ）処理を行い、全体のマッピングの一意性を保ちます。変更後、`updateDisplay` により再描画します。

### その他の補助処理
- `updateCount()`: ユーザーが入力したカスタム文字の個数をカウントして `id="cnt"` に表示します。
- `window.addEventListener('beforeunload', ...)`: ページを離れる直前に全ての `<input type="text">` の値をクリアし、情報の残留を防ぎます。

### 印刷用バージョンの生成（generatePrintVersion 関数）
新規ウィンドウを開いて印刷用の HTML を生成します。元のページの `<style>` 要素を取得して印刷用ページに適用し、マッピング結果をリストとして追加します。
